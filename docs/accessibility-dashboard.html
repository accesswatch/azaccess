<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Accessibility Dashboard — AZAccess</title>
  <meta name="description" content="Accessibility scan dashboard showing WCAG 2.2 AA findings and remediation guidance">
    <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.4;color:#111}
    html,body{height:100%}
    body{margin:0;padding:1rem;max-width:1000px;background:#fff;color:#111}
    header{border-bottom:1px solid #ddd;padding-bottom:0.5rem;margin-bottom:1rem}
    .summary{display:flex;gap:1rem;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #e6e6e6;padding:1rem;border-radius:6px;min-width:180px}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:0.5rem;border:1px solid #ddd;text-align:left}
    a{color:#0a58ca}
    button{margin-right:0.5rem}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    :focus{outline:3px solid #004b87;outline-offset:3px}
    @media (prefers-reduced-motion: reduce){
      *{transition:none!important}
    }
    @media (prefers-contrast: more){
      body{background:#fff;color:#000}
      .card{border-color:#000}
    }
    </style>
</head>
<body>
  <a class="sr-only" href="#main-content">Skip to main content</a>
  <header>
    <h1>Accessibility Dashboard</h1>
    <p id="site-desc">WCAG 2.2 AA scan summary and prioritized remediation guidance.</p>
    <nav aria-label="breadcrumb">
      <a href="/">Home</a> › <a href="/docs/">Docs</a> › Accessibility Dashboard
    </nav>
  </header>

  <main>
    <section aria-labelledby="scan-status">
      <h2 id="scan-status">Latest Scan</h2>
      <p id="scan-announcement" class="sr-only" aria-live="polite">Loading latest accessibility scan summary.</p>
      <div class="summary" id="summary" aria-live="polite" aria-atomic="true"></div>
    </section>

    <section aria-labelledby="top-issues">
      <h2 id="top-issues">Top Issues (WCAG 2.2 AA)</h2>
      <div id="issues-controls" style="margin-bottom:0.5rem">
        <button id="view-table" aria-pressed="true">Table view</button>
        <button id="view-chart" aria-pressed="false">Chart view</button>
        <a id="download-json" href="/reports/accessibility.json" download="accessibility.json">Download JSON</a>
      </div>
      <div id="issues-container" role="region" aria-live="polite">
        <p>Loading recent scan results…</p>
      </div>
    </section>

    <section aria-labelledby="lessons-learned">
      <h2 id="lessons-learned">Actionable Lessons & Remediation Impact</h2>
      <p>This section highlights prioritized fixes and expected impact on accessibility score.</p>
      <div id="lessons"></div>
    </section>
  </main>

  <footer style="margin-top:2rem;border-top:1px solid #eee;padding-top:1rem">
    <small>Report served from <a href="/reports/accessibility.json">/reports/accessibility.json</a>. Generated by GitHub Accessibility Scanner.</small>
  </footer>

  <script>
  // Accessible dashboard renderer — tolerant of multiple report shapes.
  async function loadReport(){
    const out = document.getElementById('issues-container');
    const summary = document.getElementById('summary');
    const lessons = document.getElementById('lessons');
    try{
      const res = await fetch('/reports/accessibility.json', {cache: 'no-store'});
      if(!res.ok) throw new Error('Could not fetch report');
      const data = await res.json();

      // Normalise different scanner outputs: axe-like 'violations', or array of issues.
      let issues = [];
      if(Array.isArray(data)) issues = data;
      else if(data.violations) issues = data.violations;
      else if(data.results) issues = data.results;
      else if(data.issues) issues = data.issues;

      // If issues contain 'nodes' inside (axe format), expand them into occurrences
      const occurrences = [];
      issues.forEach(issue => {
        const id = issue.id || issue.rule || issue.ruleId || issue.code || 'unknown';
        const impact = issue.impact || issue.severity || issue.level || 'unknown';
        if(issue.nodes && Array.isArray(issue.nodes) && issue.nodes.length){
          issue.nodes.forEach(node=>{
            occurrences.push({id, impact, html: node.html || node.target || node.selector || '', help: issue.help||issue.description||''});
          });
        } else if(issue.targets && Array.isArray(issue.targets)){
          issue.targets.forEach(t=>occurrences.push({id, impact, html: t, help: issue.description||''}));
        } else {
          occurrences.push({id, impact, html: issue.target || issue.selector || '', help: issue.help||issue.description||''});
        }
      });

      const total = occurrences.length;
      const byId = {}; const byImpact = {};
      occurrences.forEach(o=>{
        byId[o.id] = (byId[o.id]||0)+1;
        const imp = o.impact||'unknown'; byImpact[imp] = (byImpact[imp]||0)+1;
      });

      summary.innerHTML = `
        <div class="card"><strong>Total issues</strong><div aria-hidden="true">${total}</div></div>
        <div class="card"><strong>Unique issue types</strong><div aria-hidden="true">${Object.keys(byId).length}</div></div>
        <div class="card"><strong>Impact breakdown</strong><div aria-hidden="true">${Object.entries(byImpact).map(k=>k.join(': ')).join(' • ')}</div></div>
      `;

      if(total===0){
        out.innerHTML = '<p>No WCAG 2.2 AA issues found.</p>';
        lessons.innerHTML = '<p>Good job — no immediate AA remediation required.</p>';
        return;
      }

      // Top rules by count
      const top = Object.entries(byId).sort((a,b)=>b[1]-a[1]).slice(0,10);
      const rows = ['<table><thead><tr><th>Rule</th><th>Count</th><th>Suggested Fix</th></tr></thead><tbody>'];

      // small mapping of common rules to quick suggestions
      const suggestions = {
        'color-contrast': 'Increase text/background contrast to 4.5:1 for normal text.',
        'image-alt': 'Add descriptive alt text for informative images or empty alt for decorative images.',
        'label': 'Ensure form controls have associated labels.',
        'link-name': 'Provide meaningful link text; avoid "click here".',
        'heading-order': 'Use semantic heading order (H1 → H2 → H3) without skipping levels.'
      };

      top.forEach(([rule,count])=>{
        const suggestion = suggestions[rule] || 'Review occurrences and apply WCAG AA remediation guidance.';
        rows.push(`<tr><td>${escapeHtml(rule)}</td><td>${count}</td><td>${escapeHtml(suggestion)}</td></tr>`);
      });
      rows.push('</tbody></table>');
      out.innerHTML = rows.join('');

      // Lessons: show top 5 with context and expected impact (simple heuristic)
      const lessonsHtml = top.slice(0,5).map(([rule,count])=>{
        const fix = suggestions[rule]||'See WCAG guidance.';
        const impact = count>10 ? 'High' : (count>3 ? 'Medium' : 'Low');
        return `<div class="card" style="width:100%"><h3>${escapeHtml(rule)} — ${impact} priority</h3><p><strong>Occurrences:</strong> ${count}</p><p><strong>Quick fix:</strong> ${escapeHtml(fix)}</p></div>`;
      }).join('');
      lessons.innerHTML = lessonsHtml;

      // Try to load historical index to show trend
      try{
        const idxRes = await fetch('/reports/history/index.json', {cache: 'no-store'});
        if(idxRes.ok){
          const idx = await idxRes.json();
          renderTrend(idx, summary);
        }
      }catch(e){ /* ignore history errors */ }

    }catch(err){
      console.error(err);
      document.getElementById('issues-container').innerHTML = '<p>Error loading report — ensure <code>/reports/accessibility.json</code> exists.</p>';
    }
  }

  function renderTrend(indexArray, container){
    if(!Array.isArray(indexArray) || indexArray.length===0) return;
    const points = indexArray.slice(0,30).reverse(); // oldest -> newest
    const values = points.map(p => p.totalIssues || 0);
    const w = 600, h = 80, pad = 4;
    const max = Math.max(...values, 1);
    const min = Math.min(...values, 0);
    const scaleX = (i) => pad + (i*(w-2*pad)/(values.length-1 || 1));
    const scaleY = (v) => h - pad - ((v-min)/(max-min || 1))*(h-2*pad);
    const d = values.map((v,i)=>`${i===0? 'M':'L'} ${scaleX(i)} ${scaleY(v)}`).join(' ');
    const svg = `<svg width="${w}" height="${h}" aria-hidden="true"><polyline fill="none" stroke="#0a58ca" stroke-width="2" points="${values.map((v,i)=>`${scaleX(i)},${scaleY(v)}`).join(' ')}"/></svg>`;
    const latest = points[points.length-1];
    const latestHtml = `<div class="card"><strong>Latest (history)</strong><div aria-hidden="true">${latest ? latest.totalIssues : '—'}</div></div>`;
    container.insertAdjacentHTML('beforeend', latestHtml + `<div class="card"><strong>Trend (last ${points.length})</strong>${svg}</div>`);
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  loadReport();
  </script>
</body>
</html>
